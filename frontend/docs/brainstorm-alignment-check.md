# Brainstorm feed alignment audit

## What already matches the Cursor brief

1. **Three-column layout + mobile tabs** – `BrainstormFeed` renders `BrainstormLayoutShell` with left/center/right children that map to Last Seen, the Feed+Canvas, and Cross-links + Sidebar. The layout component enforces tabs on mobile and three panels on desktop, matching the requested UX scaffolding.【F:src/pages/brainstorm/BrainstormFeed.tsx†L13-L117】【F:src/features/brainstorm/components/BrainstormLayoutShell.tsx†L5-L70】
2. **Universal feed driving the center column** – The center column is a `FeedContainer` in `brainstorm_main` mode, which delegates to `useUniversalFeed`. That hook queries canonical `posts` (plus `open_ideas_public_view`) via `fetchUniversalFeed`, so the scroll list and canvas both read from the same Supabase rows.【F:src/pages/brainstorm/BrainstormFeed.tsx†L70-L78】【F:src/features/feed/hooks/useUniversalFeed.ts†L6-L86】【F:src/lib/feedQueries.ts†L94-L205】
3. **Canvas + cross-links use `post_relations`** – Selecting a card wires through `useBrainstormExperienceStore`, which keeps history/breadcrumbs and feeds IDs into `useBrainstormGraph`. That hook loads neighboring posts/edges from `post_relations`, so the canvas, cross-links list, and breadcrumbs all share the same canonical relation table.【F:src/features/brainstorm/components/BrainstormFeedRenderer.tsx†L19-L95】【F:src/features/brainstorm/stores/experience.ts†L6-L89】【F:src/features/brainstorm/hooks/useBrainstormGraph.ts†L32-L114】【F:src/lib/feedQueries.ts†L229-L283】
4. **Last Seen + Cross-links + Right sidebar all reuse the same card system** – `LastSeenFeed`, `CrossLinksFeed`, and the `RightSidebar` tabs are backed by `FeedContainer` modes (`brainstorm_last_seen`, `brainstorm_cross_links`, `brainstorm_open_ideas`) and render `BrainstormPostCard`s, so every column is visually consistent and receives selections via the shared experience store.【F:src/features/brainstorm/components/LastSeenFeed.tsx†L9-L43】【F:src/features/brainstorm/components/CrossLinksFeed.tsx†L5-L42】【F:src/components/layout/RightSidebar.tsx†L1-L105】
5. **Composer + Link Picker still respond to pb events** – The main page listens for `pb:brainstorm:continue` / `pb:brainstorm:link` and opens `NodeForm` or `LinkPicker`, so the legacy GlowCard/FeedCard buttons keep working under the new architecture.【F:src/pages/brainstorm/BrainstormFeed.tsx†L26-L117】【F:src/features/brainstorm/components/NodeForm.tsx†L41-L200】【F:src/features/brainstorm/components/LinkPicker.tsx†L1-L120】

## Gaps and regressions to flag for the next prompt

1. **Legacy Hub + Live Window code still ships** – Even though `/brainstorms*` routes now redirect, the `Brainstorms` page, `useBrainstorms` hook, and `LiveBrainstormWindow` remain in the bundle. `BusinessFeed` still renders that live window, so the business experience keeps instantiating the legacy hook + components that were supposed to be deprecated.【F:src/pages/Brainstorms.tsx†L1-L131】【F:src/hooks/useBrainstorms.ts†L37-L193】【F:src/components/feeds/BusinessFeed.tsx†L1-L220】【F:src/components/brainstorm/LiveBrainstormWindow.tsx†L1-L120】
2. **Adapter/store duplication** – `NodeForm` still depends on `useBrainstormStore` and `BrainstormSupabaseAdapter`, which target the old `TABLES.BRAINSTORM_NODES` RPC pipeline. The new feed/canvas ignores that store entirely (it renders whatever `useBrainstormGraph` fetches), so optimistic updates from `addNodeOptimistic` / `addEdgeOptimistic` never hit the visible canvas. This adds dead state and two competing data models.【F:src/features/brainstorm/components/NodeForm.tsx†L12-L200】【F:src/features/brainstorm/components/BrainstormFeedRenderer.tsx†L50-L95】【F:src/features/brainstorm/adapters/supabaseAdapter.ts†L16-L133】
3. **Map still points at the standalone `brainstorms` table** – `BrainstormMap.tsx` continues to read and subscribe to the legacy `brainstorms` table instead of the canonical `posts` + `post_relations` model, so any usage of that map drifts away from the new source of truth.【F:BrainstormMap.tsx†L19-L174】
4. **Center feed is not truly infinite** – `BrainstormFeed` injects `BrainstormFeedRenderer` via the `renderFeed` prop but never wires `feed.loadMore` to scrolling, so the main column stops after the first batch unless someone hits Refresh. The list is rendered manually instead of reusing `FeedList`, so pagination helpers from `FeedContainer` are bypassed.【F:src/pages/brainstorm/BrainstormFeed.tsx†L70-L78】【F:src/features/brainstorm/components/BrainstormFeedRenderer.tsx†L50-L70】【F:src/features/feed/FeedContainer.tsx†L57-L90】
5. **Multiple parallel stores** – We now have `useBrainstormExperienceStore` for selection + history and the original `useBrainstormStore` for nodes/edges/threadQueue. Most new UI relies on the former, while composer tooling still mutates the latter. This duplication increases bug surface (e.g., breadcrumbs never see optimistic nodes).【F:src/features/brainstorm/stores/experience.ts†L6-L89】【F:src/features/brainstorm/store.ts†L1-L120】

## Suggested cleanup / decluttering next steps

1. **Fully remove or quarantine the legacy hub** – Delete/disable `Brainstorms.tsx`, `LiveBrainstormWindow`, and `useBrainstorms` (or wrap them in a legacy-only export) so new routes no longer import that code. Replace the `BusinessFeed` sidebar with a read-only `FeedContainer` variant so both public & business surfaces pull from the same hooks.【F:src/components/feeds/BusinessFeed.tsx†L1-L220】【F:src/components/brainstorm/LiveBrainstormWindow.tsx†L1-L120】
2. **Collapse onto one Brainstorm store** – Update `NodeForm`/`LinkPicker` to push new posts straight into Supabase and then call `useBrainstormExperienceStore.setActivePost` / `useBrainstormGraph` refresh logic, then delete `useBrainstormStore` + `BrainstormSupabaseAdapter` to avoid the dormant `brainstorm_nodes` schema.【F:src/features/brainstorm/components/NodeForm.tsx†L41-L200】【F:src/features/brainstorm/adapters/supabaseAdapter.ts†L16-L133】
3. **Port `BrainstormMap` to the canonical model or remove it** – Either fetch from `posts`+`post_relations` or drop this file so no one continues to rely on the `brainstorms` table channel.【F:BrainstormMap.tsx†L19-L174】
4. **Rewire the center feed to `FeedList`** – Instead of custom mapping in `BrainstormFeedRenderer`, pass `feed.loadMore` down (or reuse `FeedList`) so the column paginates automatically and inherits the existing infinite-scroll sentinel from `FeedContainer`.【F:src/features/brainstorm/components/BrainstormFeedRenderer.tsx†L50-L70】【F:src/features/feed/FeedContainer.tsx†L57-L90】
5. **(Optional) Persist Last Seen** – `useBrainstormExperienceStore` only keeps history in memory; consider writing it to Supabase for multi-device continuity once the single-store refactor above lands.【F:src/features/brainstorm/stores/experience.ts†L6-L89】
