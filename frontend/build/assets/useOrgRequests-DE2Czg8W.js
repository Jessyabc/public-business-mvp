import{r as i,s as t,u as m,q as o}from"./index-DdiXzYE2.js";function h(){const{user:u}=m(),[c,d]=i.useState(null),[g,n]=i.useState(!0),l=i.useCallback(async()=>{if(!u){n(!1);return}try{const{data:e,error:r}=await t.from("org_requests").select("*").eq("user_id",u.id).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(r)throw r;d(e)}catch(e){console.error("Error fetching org request:",e)}finally{n(!1)}},[u]);return i.useEffect(()=>{l()},[l]),{myRequest:c,loading:g,submitRequest:async e=>{if(!u){o.error("You must be logged in to submit a request");return}try{const{data:r,error:s}=await t.from("org_requests").insert({user_id:u.id,org_name:e.org_name,org_description:e.org_description||null,reason:e.reason||null,status:"pending"}).select().single();if(s)throw s;d(r),o.success("Organization request submitted! We will review it shortly.")}catch(r){throw console.error("Error submitting org request:",r),o.error(r.message||"Failed to submit request"),r}},updateRequest:async e=>{if(!u||!c){o.error("No request to update");return}try{const{data:r,error:s}=await t.from("org_requests").update({org_name:e.org_name,org_description:e.org_description||null,reason:e.reason||null,status:"pending",updated_at:new Date().toISOString()}).eq("id",c.id).select().single();if(s)throw s;d(r),o.success("Request updated and resubmitted!")}catch(r){throw console.error("Error updating org request:",r),o.error(r.message||"Failed to update request"),r}},refetch:l}}function y(){const[u,c]=i.useState([]),[d,g]=i.useState(!0),n=i.useCallback(async()=>{g(!0);try{const{data:a,error:e}=await t.from("org_requests").select("*").eq("status","pending").order("created_at",{ascending:!0});if(e)throw e;c(a||[])}catch(a){console.error("Error fetching org requests:",a)}finally{g(!1)}},[]);return i.useEffect(()=>{n()},[n]),{requests:u,loading:d,approveRequest:async a=>{try{const{data:e,error:r}=await t.from("org_requests").select("*").eq("id",a).single();if(r)throw r;const{data:s,error:q}=await t.rpc("create_org_and_owner",{p_name:e.org_name,p_description:e.org_description});if(q)throw q;const{data:f}=await t.auth.getUser();f?.user?.id!==e.user_id&&await t.from("org_members").insert({org_id:s,user_id:e.user_id,role:"business_admin"});const{error:p}=await t.from("org_requests").update({status:"approved",reviewed_at:new Date().toISOString(),reviewed_by:f?.user?.id||null}).eq("id",a);if(p)throw p;o.success("Organization created and request approved!"),n()}catch(e){console.error("Error approving org request:",e),o.error(e.message||"Failed to approve request")}},rejectRequest:async(a,e)=>{try{const{data:r}=await t.auth.getUser(),{error:s}=await t.from("org_requests").update({status:"rejected",reason:e||"Request rejected by admin",reviewed_at:new Date().toISOString(),reviewed_by:r?.user?.id||null}).eq("id",a);if(s)throw s;o.success("Request rejected"),n()}catch(r){console.error("Error rejecting org request:",r),o.error(r.message||"Failed to reject request")}},refetch:n}}export{h as a,y as u};
