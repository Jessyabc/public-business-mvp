const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rpc-CPiWz0sY.js","assets/index-DdiXzYE2.js","assets/index-s0UwzZhW.css"])))=>i.map(i=>d[i]);
import{u as b,ap as C,r as o,s as u,_ as g}from"./index-DdiXzYE2.js";function S(r){const a=Date.now(),d=new Date(r.expires_at).getTime();return r.consumed_at?"used":d<=a?"expired":"pending"}function D(){const{user:r}=b(),{toast:a}=C(),[d,n]=o.useState(!1),[p,_]=o.useState([]),[w,v]=o.useState([]),c=o.useCallback(async()=>{if(r){n(!0);try{const{data:t,error:e}=await u.from("business_invitations").select("id, invitee_email, inviter_id, token, role, consumed_at, expires_at, created_at").eq("inviter_id",r.id).order("created_at",{ascending:!1});if(e)throw e;_(t||[])}catch(t){console.error("Error fetching sent invitations:",t);let e="Failed to fetch sent invitations";(t instanceof Error||t&&typeof t=="object"&&"message"in t&&typeof t.message=="string")&&(e=t.message),a({title:"Error",description:e,variant:"destructive"})}finally{n(!1)}}},[r,a]),f=o.useCallback(async()=>{if(r){n(!0);try{const{data:t}=await u.auth.getUser(),e=t.user?.email;if(!e)return;const{data:i,error:s}=await u.from("business_invitations").select("id, invitee_email, inviter_id, token, role, consumed_at, expires_at, created_at").eq("invitee_email",e.toLowerCase()).is("consumed_at",null).gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1});if(s)throw s;v(i||[])}catch(t){console.error("Error fetching received invitations:",t);let e="Failed to fetch received invitations";(t instanceof Error||t&&typeof t=="object"&&"message"in t&&typeof t.message=="string")&&(e=t.message),a({title:"Error",description:e,variant:"destructive"})}finally{n(!1)}}},[r,a]),y=o.useCallback(async t=>{if(!r)return a({title:"Authentication Required",description:"Please sign in to send invitations",variant:"destructive"}),null;n(!0);try{const{rpcCreateBusinessInvite:e}=await g(async()=>{const{rpcCreateBusinessInvite:m}=await import("./rpc-CPiWz0sY.js");return{rpcCreateBusinessInvite:m}},__vite__mapDeps([0,1,2])),{data:i,error:s}=await e(t.invitee_email);if(s)throw s;await c();const l=(i??[])[0];return l&&a({title:"Invite created",description:`Link ready. Expires ${new Date(l.expires_at).toLocaleDateString()}`}),l}catch(e){console.error("Error creating invitation:",e);let i="Failed to send invitation";throw(e instanceof Error||e&&typeof e=="object"&&"message"in e&&typeof e.message=="string")&&(i=e.message),a({title:"Error",description:i,variant:"destructive"}),e}finally{n(!1)}},[r,a,c]),h=o.useCallback(async t=>{if(!r)return!1;n(!0);try{const{rpcConsumeInvite:e}=await g(async()=>{const{rpcConsumeInvite:s}=await import("./rpc-CPiWz0sY.js");return{rpcConsumeInvite:s}},__vite__mapDeps([0,1,2])),{error:i}=await e(t);if(i)throw i;return a({title:"Welcome!",description:"Business Member access granted."}),v(s=>s.filter(l=>l.token!==t)),await c(),!0}catch(e){console.error("Error accepting invitation:",e);let i="Failed to accept invitation";return(e instanceof Error||e&&typeof e=="object"&&"message"in e&&typeof e.message=="string")&&(i=e.message),a({title:"Error",description:i,variant:"destructive"}),!1}finally{n(!1)}},[r,a,c]),E=o.useCallback(async t=>{if(!r)return!1;n(!0);try{const{data:e}=await u.auth.getUser(),i=e.user?.email?.toLowerCase();if(!i)throw new Error("No email");const{error:s}=await u.from("business_invitations").update({consumed_at:new Date().toISOString()}).eq("id",t).eq("invitee_email",i).is("consumed_at",null);if(s)throw s;return v(l=>l.filter(m=>m.id!==t)),a({title:"Invitation declined",description:"The invitation was closed."}),!0}catch(e){console.error("Error rejecting invitation:",e);let i="Failed to reject invitation";return(e instanceof Error||e&&typeof e=="object"&&"message"in e&&typeof e.message=="string")&&(i=e.message),a({title:"Error",description:i,variant:"destructive"}),!1}finally{n(!1)}},[r,a]),I=o.useCallback(t=>S(t),[]);return o.useEffect(()=>{r&&(c(),f())},[r,c,f]),{invitations:p,receivedInvitations:w,loading:d,createInvitation:y,acceptInvitation:h,rejectInvitation:E,fetchSentInvitations:c,fetchReceivedInvitations:f,refetch:()=>{c(),f()},getInvitationStatus:I}}export{D as u};
