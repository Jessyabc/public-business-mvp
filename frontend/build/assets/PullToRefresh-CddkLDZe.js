import{H as ye,J as De,K as te,r as o,N as Ae,O as Te,Q as qe,R as Be,V as Fe,W as ie,u as we,s as q,X as _e,d as ze,Y as He,j as s,Z as I,M as Ve,$ as We,c as w,q as oe,a0 as Oe,a1 as ke,a2 as je,B as ee,a3 as Ue,a4 as Ce,a5 as Ze,a6 as Xe}from"./index-DdiXzYE2.js";import{u as Se,P as de}from"./PostToSparkCard-BEdnMnl8.js";import{B as Ye,P as Ke}from"./PostReaderModal-Btyl2ffZ.js";import{A as pe}from"./arrow-right-CyP0_zRv.js";import{C as Ne}from"./chevron-down-DsrBl0uX.js";import{L as Ge}from"./loader-circle-Eg68qUzz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=ye("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=ye("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);function et(...t){const e=!Array.isArray(t[0]),a=e?0:-1,r=t[0+a],n=t[1+a],d=t[2+a],l=t[3+a],c=De(n,d,l);return e?c(r):c}function Me(t){const e=te(()=>Te(t)),{isStatic:a}=o.useContext(Ae);if(a){const[,r]=o.useState(t);o.useEffect(()=>e.on("change",r),[])}return e}function Ee(t,e){const a=Me(e()),r=()=>a.set(e());return r(),qe(()=>{const n=()=>Fe.preRender(r,!1,!0),d=t.map(l=>l.on("change",n));return()=>{d.forEach(l=>l()),Be(r)}}),a}function tt(t){ie.current=[],t();const e=Ee(ie.current,t);return ie.current=void 0,e}function G(t,e,a,r){if(typeof t=="function")return tt(t);if(a!==void 0&&!Array.isArray(a)&&typeof e!="function")return st(t,e,a,r);const l=typeof e=="function"?e:et(e,a,r);return Array.isArray(t)?xe(t,l):xe([t],([c])=>l(c))}function xe(t,e){const a=te(()=>[]);return Ee(t,()=>{a.length=0;const r=t.length;for(let n=0;n<r;n++)a[n]=t[n].get();return e(a)})}function st(t,e,a,r){const n=te(()=>Object.keys(a)),d=te(()=>({}));for(const l of n)d[l]=G(t,e,a[l],r);return d}async function rt(t,e){const{data:a,error:r}=await t.rpc("get_lineage_clusters",{p_mode:e.mode,p_limit:e.limit??20,p_cursor:e.cursor??null,p_kinds:e.kinds??null,p_search:e.search??null,p_org_id:e.org_id??null,p_user_id:e.user_id??null});if(r)return console.error("Error fetching clusters via RPC:",r),{clusters:[],nextCursor:null};const d=(a||[]).map(c=>({spark:c.spark_data,continuations:c.continuations.map(b=>({post:b.post,depth:b.depth,descendantCount:b.descendant_count,score:b.score,parentId:b.parent_id})),latestActivityAt:c.latest_activity_at,totalContinuations:c.total_continuations})),l=d.length===(e.limit??20)?d[d.length-1].latestActivityAt:null;return{clusters:d,nextCursor:l}}function nt(t,e=5){return t.continuations.filter(r=>r.depth===1).sort((r,n)=>n.score-r.score).slice(0,e)}function at(t,e=5){return t.continuations.filter(r=>r.depth===1).sort((r,n)=>n.score-r.score).map((r,n)=>({...r,fadeOpacity:n<e?1:Math.max(.3,1-(n-e)*.15)}))}function it(t){return t.continuations.filter(e=>e.depth>3).length}async function me(t,e){if(e.length===0)return new Map;const a=Array.from(new Set(e.filter(Boolean))),{data:r,error:n}=await t.from("profile_cards").select("id, display_name").in("id",a);return n?(console.error("Error fetching author profiles:",n),new Map):new Map((r||[]).map(d=>[d.id,d.display_name]))}async function ot(t,e){const a=e.limit??20,r=e.cursor??new Date().toISOString();let n=t.from("posts").select("*").eq("status","active").lt("created_at",r).order("created_at",{ascending:!1}).limit(a);if(e.mode==="public")n=n.eq("mode","public").eq("visibility","public");else if(e.mode==="business")if(n=n.eq("mode","business"),n=n.not("published_at","is",null),e.org_id)if(e.user_id){const g=t.from("posts").select("*").eq("status","active").lt("created_at",r).eq("mode","business").not("published_at","is",null).eq("org_id",e.org_id).in("visibility",["my_business","other_businesses","public"]),m=t.from("posts").select("*").eq("status","active").lt("created_at",r).eq("mode","business").not("published_at","is",null).eq("user_id",e.user_id).not("visibility","is",null);e.kinds&&e.kinds.length>0&&(g.in("kind",e.kinds),m.in("kind",e.kinds)),e.search&&(g.or(`title.ilike.%${e.search}%,content.ilike.%${e.search}%`),m.or(`title.ilike.%${e.search}%,content.ilike.%${e.search}%`));const[x,f]=await Promise.all([g.order("created_at",{ascending:!1}),m.order("created_at",{ascending:!1})]);x.error&&console.error("Org query error:",x.error),f.error&&console.error("User query error:",f.error);const y=new Map;[...x.data||[],...f.data||[]].forEach(R=>{y.set(R.id,R)});const k=Array.from(y.values());k.sort((R,B)=>new Date(B.created_at).getTime()-new Date(R.created_at).getTime());const S=k.slice(0,a),$=S.length===a?S[S.length-1].created_at:null,N=S.map(R=>R.user_id).filter(Boolean),H=await me(t,N);return{items:S,nextCursor:$,authorMap:H}}else n=n.eq("org_id",e.org_id).in("visibility",["my_business","other_businesses","public"]);else e.user_id?n=n.or(`visibility.eq.public,user_id.eq.${e.user_id}`):n=n.eq("visibility","public");e.kinds&&e.kinds.length>0&&(n=n.in("kind",e.kinds)),e.search&&(n=n.or(`title.ilike.%${e.search}%,content.ilike.%${e.search}%`));const{data:d,error:l}=await n;if(l)return console.error("Feed query error:",l,{mode:e.mode,org_id:e.org_id,user_id:e.user_id,kinds:e.kinds}),{items:[],nextCursor:null};const c=d||[],b=c.length===a?c[c.length-1].created_at:null,v=c.map(g=>g.user_id).filter(Boolean),u=await me(t,v);return{items:c,nextCursor:b,authorMap:u}}async function lt(t,e){if(!e.postId)return[];const{data:a,error:r}=await t.from("post_relations").select("parent_post_id, child_post_id").eq("relation_type","cross_link").or(`parent_post_id.eq.${e.postId},child_post_id.eq.${e.postId}`);if(r||!a||a.length===0)return[];const n=new Set;if(a.forEach(c=>{c.parent_post_id!==e.postId&&n.add(c.parent_post_id),c.child_post_id!==e.postId&&n.add(c.child_post_id)}),n.size===0)return[];const{data:d,error:l}=await t.from("posts").select("*").in("id",Array.from(n)).eq("status","active");return l?(console.error("Cross-links query error:",l),[]):d||[]}async function ct(t,e){return rt(t,{mode:e.mode,limit:e.limit??20,cursor:e.cursor,kinds:e.kinds??null,search:e.search,org_id:e.org_id,user_id:e.user_id??null})}function dt(t){const{user:e}=we(),[a,r]=o.useState([]),[n,d]=o.useState(null),[l,c]=o.useState(!1),[b,v]=o.useState(!1),u=o.useRef(!1),[g,m]=o.useState(new Map),x=o.useCallback(async(f=!1)=>{if(!u.current){u.current=!0,c(!0);try{if(t.mode==="brainstorm_last_seen"){r([]),d(null),v(!0);return}if(t.mode==="brainstorm_cross_links"){const N=await lt(q,{postId:t.activePostId});r(N),d(null),v(!0);return}const y=t.mode==="public"||t.mode==="brainstorm_main"?"public":t.mode==="business"?"business":"public",{items:k,nextCursor:S,authorMap:$}=await ot(q,{mode:y,kinds:t.kinds,sort:t.sort,search:t.search,org_id:y==="business"?t.org_id:null,user_id:y==="business"&&e?.id||null,cursor:f?null:n,limit:t.pageSize??20});r(N=>f?k:[...N,...k]),d(S),v(!S),$&&m(N=>{const H=new Map(N);return $.forEach((R,B)=>H.set(B,R)),H})}catch(y){console.error("Failed to load feed:",y),v(!0)}finally{c(!1),u.current=!1}}},[t.mode,t.kinds,t.sort,t.search,t.org_id,t.pageSize,t.activePostId,n,e?.id]);return o.useEffect(()=>{d(null),v(!1),m(new Map),x(!0)},[t.mode,JSON.stringify(t.kinds),t.sort,t.search,t.org_id,t.activePostId]),{items:a,loadMore:()=>!b&&x(!1),loading:l,eof:b,refresh:()=>x(!0),authorMap:g}}function ut(t){const{user:e}=we(),[a,r]=o.useState([]),[n,d]=o.useState(null),[l,c]=o.useState(!1),[b,v]=o.useState(!1),u=o.useRef(!1),g=o.useCallback(async(f=!1)=>{if(!u.current){u.current=!0,c(!0);try{const{clusters:y,nextCursor:k}=await ct(q,{mode:t.mode,kinds:t.kinds,search:t.search,org_id:t.org_id,cursor:f?null:n,limit:t.pageSize??20,user_id:e?.id??null});r(S=>f?y:[...S,...y]),d(k),v(!k)}catch(y){console.error("Failed to load cluster feed:",y),v(!0)}finally{c(!1),u.current=!1}}},[t.mode,t.kinds,t.search,t.org_id,t.pageSize,n,e?.id]);o.useEffect(()=>{d(null),v(!1),g(!0)},[t.mode,JSON.stringify(t.kinds),t.search,t.org_id]);const m=o.useCallback(async()=>{!b&&!l&&await g(!1)},[b,l,g]),x=o.useCallback(async()=>{d(null),v(!1),await g(!0)},[g]);return{clusters:a,loadMore:m,loading:l,eof:b,refresh:x}}function ft(t){const[e,a]=o.useState(t?.kinds??["Spark","BusinessInsight"]),[r,n]=o.useState(t?.sort??"new"),[d,l]=o.useState(t?.search??null);return o.useMemo(()=>({kinds:e,setKinds:a,sort:r,setSort:n,search:d,setSearch:l}),[e,r,d])}function ht({children:t,postId:e,postTitle:a,onSwipeLeft:r,onSwipeRight:n,onLongPress:d,className:l}){const[c,b]=o.useState(!1),[v,u]=o.useState(!1),g=o.useRef(null),m=_e(),{openComposer:x}=ze(),{addRef:f,hasRef:y,pendingRefs:k,removeRef:S}=He(),$=y(e),N=Me(0),H=G(N,[-150,0,150],[-5,0,5]),R=G(N,[-150,-50,0],[1,.5,0]),B=G(N,[0,50,150],[0,.5,1]),V=G(N,[-150,0,150],[.95,1,.95]),F=()=>{b(!0),g.current&&clearTimeout(g.current)},U=(ue,Z)=>{b(!1);const Q=100;Z.offset.x<-Q?r?r():($&&S(e),x({parentPostId:e,relationType:"continuation"}),oe.success(`Continuing: ${a||"this Spark"}`)):Z.offset.x>Q&&(n?n():$?(S(e),oe.info("Removed from references")):(f(e),oe.success(`Added to references (${k.length+1})`,{description:"Will be linked to your next Spark"})))},T=()=>{g.current=setTimeout(()=>{c||(d?d():window.dispatchEvent(new CustomEvent("pb:post:preview",{detail:{postId:e}})))},500)},D=()=>{g.current&&clearTimeout(g.current)};return s.jsxs("div",{className:w("relative group",l),onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:[m&&s.jsx(I.div,{style:{opacity:R},className:"absolute inset-y-0 left-0 w-20 flex items-center justify-center pointer-events-none",children:s.jsxs("div",{className:"flex flex-col items-center gap-1 text-[hsl(var(--accent))]",children:[s.jsx(Ve,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs font-medium",children:"Continue"})]})}),m&&s.jsx(I.div,{style:{opacity:B},className:"absolute inset-y-0 right-0 w-20 flex items-center justify-center pointer-events-none",children:s.jsxs("div",{className:w("flex flex-col items-center gap-1",$?"text-green-400":"text-purple-400"),children:[$?s.jsx(We,{className:"w-6 h-6"}):s.jsx(Ye,{className:"w-6 h-6"}),s.jsx("span",{className:"text-xs font-medium",children:$?"Remove":"Reference"})]})}),$&&s.jsx("div",{className:"absolute top-2 right-2 z-20 px-2 py-0.5 rounded-full bg-purple-500/20 border border-purple-500/40 text-[10px] text-purple-300",children:"Referenced"}),s.jsxs(I.div,{style:{x:N,rotate:H,scale:V},drag:m?"x":!1,dragConstraints:{left:0,right:0},dragElastic:.7,onDragStart:F,onDragEnd:U,onPointerDown:m?T:void 0,onPointerUp:m?D:void 0,onPointerLeave:m?D:void 0,whileTap:m?{scale:.98}:void 0,className:w("relative",m&&"cursor-grab active:cursor-grabbing touch-pan-y",c&&"z-10"),children:[t,m&&!c&&s.jsx("div",{className:"absolute inset-x-0 bottom-2 flex justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:s.jsxs("div",{className:"flex items-center gap-2 text-xs text-white/30",children:[s.jsx(pe,{className:"w-3 h-3 rotate-180"}),s.jsx("span",{children:"Swipe"}),s.jsx(pe,{className:"w-3 h-3"})]})})]})]})}function pt(t,e){const[a,r]=o.useState(t);return o.useEffect(()=>{const n=setTimeout(()=>{r(t)},e);return()=>{clearTimeout(n)}},[t,e]),a}async function xt(t,e){const a=e==="above"?"child_post_id":"parent_post_id",r=e==="above"?"parent_post_id":"child_post_id",{data:n}=await q.from("post_relations").select(`${r}`).eq(a,t).in("relation_type",["reply","origin"]).limit(3);if(!n?.length)return[];const d=n.map(u=>u[r]),{data:l}=await q.from("posts").select("id, title, content, user_id").in("id",d);if(!l)return[];const c=l.map(u=>u.user_id).filter(Boolean),{data:b}=await q.from("profiles").select("id, display_name").in("id",c),v=new Map(b?.map(u=>[u.id,u.display_name])||[]);return l.map(u=>({id:u.id,title:u.title,content:u.content,author_name:v.get(u.user_id)||"Anonymous"}))}function ge({postId:t,isHovered:e,position:a}){const r=pt(e,300),{data:n=[]}=Oe({queryKey:["lineage-preview",t,a],queryFn:()=>xt(t,a),enabled:r,staleTime:5*60*1e3,gcTime:10*60*1e3});return!e||n.length===0?null:s.jsx(ke,{children:s.jsxs(I.div,{initial:{opacity:0,y:a==="above"?10:-10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:a==="above"?10:-10,scale:.95},transition:{duration:.2,ease:"easeOut"},className:w("absolute left-4 right-4 z-50 pointer-events-none",a==="above"?"-top-2 -translate-y-full":"-bottom-2 translate-y-full"),children:[s.jsx("div",{className:w("flex items-center justify-center mb-2",a==="below"&&"flex-col-reverse mt-2 mb-0"),children:a==="above"?s.jsx(je,{className:"w-4 h-4 text-[var(--accent)]/50 animate-pulse"}):s.jsx(Ne,{className:"w-4 h-4 text-[var(--accent)]/50 animate-pulse"})}),s.jsx("div",{className:"space-y-2",children:n.map((d,l)=>s.jsxs(I.div,{initial:{opacity:0,x:-10},animate:{opacity:1-l*.2,x:0},transition:{delay:l*.05},className:w("p-3 rounded-xl","bg-[var(--glass-bg)] backdrop-blur-[var(--glass-blur)] border border-[var(--glass-border)]","shadow-lg shadow-black/20"),style:{transform:`scale(${1-l*.05})`,marginLeft:`${l*8}px`},children:[s.jsx("p",{className:"text-xs text-[var(--text-secondary)] mb-1",children:d.author_name}),s.jsx("p",{className:"text-sm text-[var(--text-primary)] line-clamp-2",children:d.title||d.content.slice(0,100)})]},d.id))}),s.jsx("div",{className:w("absolute inset-0 rounded-xl opacity-30 blur-xl -z-10","bg-gradient-to-b from-[hsl(var(--accent))]/20 to-transparent")})]})})}function mt({nodes:t,sparkPosition:e}){const a=o.useRef(null);return o.useEffect(()=>{const r=a.current;if(!r)return;const n=r.getContext("2d");if(!n)return;const d=()=>{r.width=window.innerWidth,r.height=window.innerHeight};d(),window.addEventListener("resize",d);const l=r.width/2,c=r.height/2,b=Math.max(r.width,r.height)*.8;if([{radius:b*.4,opacity:.03,r:72,g:159,b:227},{radius:b*.6,opacity:.02,r:30,g:102,b:245},{radius:b*.8,opacity:.015,r:72,g:159,b:227}].forEach(u=>{const g=n.createRadialGradient(l,c,0,l,c,u.radius);g.addColorStop(0,`rgba(${u.r}, ${u.g}, ${u.b}, ${u.opacity})`),g.addColorStop(.5,`rgba(${u.r}, ${u.g}, ${u.b}, ${u.opacity*.5})`),g.addColorStop(1,`rgba(${u.r}, ${u.g}, ${u.b}, 0)`),n.fillStyle=g,n.fillRect(0,0,r.width,r.height)}),e){const u=l+e.x,g=c+e.y,x=n.createRadialGradient(u,g,0,u,g,250);x.addColorStop(0,"rgba(72, 159, 227, 0.10)"),x.addColorStop(.4,"rgba(72, 159, 227, 0.06)"),x.addColorStop(.7,"rgba(72, 159, 227, 0.03)"),x.addColorStop(1,"rgba(72, 159, 227, 0)"),n.fillStyle=x,n.fillRect(0,0,r.width,r.height)}t.length>1&&(n.strokeStyle="rgba(72, 159, 227, 0.08)",n.lineWidth=1,n.setLineDash([4,8]),t.forEach((u,g)=>{if(g===0)return;const m=l+u.x,x=c+u.y;n.beginPath(),n.moveTo(l,c),n.quadraticCurveTo(l+u.x*.3,c+u.y*.3,m,x),n.stroke()}),n.setLineDash([])),n.fillStyle="rgba(72, 159, 227, 0.15)";for(let u=0;u<30;u++){const g=Math.random()*r.width,m=Math.random()*r.height,x=Math.random()*1.5;n.beginPath(),n.arc(g,m,x,0,Math.PI*2),n.fill()}return()=>{window.removeEventListener("resize",d)}},[t,e]),s.jsx("canvas",{ref:a,className:"absolute inset-0 pointer-events-none",style:{opacity:.4}})}function gt(t){const[e,a]=o.useState(t),r=o.useRef(null);return o.useEffect(()=>(r.current!==null&&cancelAnimationFrame(r.current),r.current=requestAnimationFrame(()=>{a(t),r.current=null}),()=>{r.current!==null&&cancelAnimationFrame(r.current)}),[t]),e}const le="#4A7C9B";function be({from:t,to:e,type:a}){const r=e.x-t.x,n=e.y-t.y,d=Math.sqrt(r*r+n*n),l=Math.atan2(n,r)*(180/Math.PI);return s.jsx(I.div,{initial:{opacity:0,scaleX:0},animate:{opacity:1,scaleX:1},transition:{duration:.5},className:w("absolute origin-left pointer-events-none",a==="hard"?"h-0.5":"h-px"),style:{left:`calc(50% + ${t.x}px)`,top:`calc(50% + ${t.y}px)`,width:`${d}px`,transform:`rotate(${l}deg)`,...a==="hard"?{background:le,boxShadow:`0 0 8px ${le}, 0 0 4px ${le}80`,opacity:.9}:{background:"white",backgroundImage:"repeating-linear-gradient(90deg, white, white 8px, transparent 8px, transparent 16px)",opacity:.6}}})}function Le({rootPostId:t,isOpen:e,onClose:a,onSelectPost:r}){const[n,d]=o.useState([]),[l,c]=o.useState([]),[b,v]=o.useState([]),[u,g]=o.useState(1),[m,x]=o.useState({x:0,y:0}),[f,y]=o.useState(null),[k,S]=o.useState(null),[$,N]=o.useState(!0),[H,R]=o.useState(!0),B=o.useRef(null),V=o.useRef(null),F=o.useRef(1),U=o.useRef({x:0,y:0}),T=gt(u);o.useEffect(()=>{if(!e)return;(async()=>{const p=new Set,h=[],j=[],M=async(_,C,L,A)=>{if(p.has(_)||C>4)return;p.add(_),j.push(_);const{data:P}=await q.from("posts").select("id, title, content").eq("id",_).single();if(!P)return;const W=C*120,ae=Math.cos(A)*W,z=Math.sin(A)*W;h.push({id:P.id,title:P.title,content:P.content,x:ae,y:z,depth:C,parentId:L});const{data:O}=await q.from("post_relations").select("child_post_id").eq("parent_post_id",_).in("relation_type",["reply","hard"]);if(O?.length){const J=Math.PI*.8/Math.max(O.length,1),Y=A-J*(O.length-1)/2;for(let K=0;K<O.length;K++)await M(O[K].child_post_id,C+1,_,Y+J*K)}};if(await M(t,0,null,-Math.PI/2),d(h),j.length>0){const{data:_}=await q.from("post_relations").select("parent_post_id, child_post_id").in("relation_type",["soft","cross_link"]).or(`parent_post_id.in.(${j.join(",")}),child_post_id.in.(${j.join(",")})`);_&&v(_.map(C=>({parentId:C.parent_post_id,childId:C.child_post_id})))}const{data:E}=await q.from("posts").select("id, title, content").eq("type","brainstorm").eq("kind","Spark").eq("status","active").neq("id",t).not("id","in",`(${j.length>0?j.join(","):"null"})`).order("created_at",{ascending:!1}).limit(20);if(E){const _=E.map((C,L)=>{const A=Math.PI*2*L/E.length,P=800+Math.random()*400;return{id:C.id,title:C.title,content:C.content,x:Math.cos(A)*P,y:Math.sin(A)*P,depth:999,parentId:null}});c(_)}})()},[t,e]),o.useEffect(()=>{if(!k){y(null);return}(async()=>{const{data:p,error:h}=await q.from("posts").select("*").eq("id",k).single();!h&&p&&y(p)})()},[k]);const D=o.useCallback(()=>{V.current&&clearTimeout(V.current),V.current=setTimeout(()=>{N(!1),R(!1)},3e3)},[]);o.useEffect(()=>{if(e)return D(),F.current=u,U.current=m,()=>{V.current&&clearTimeout(V.current)}},[e,D,u,m]),o.useEffect(()=>{if(!e)return;const i=p=>{p.key==="Escape"&&a()};return window.addEventListener("keydown",i),()=>{window.removeEventListener("keydown",i)}},[e,a]),o.useEffect(()=>{if(!e||!B.current)return;let i=null;const p=j=>{j.preventDefault();const M=j.deltaY>0?-.1:.1,E=Math.max(.5,Math.min(3,F.current+M));F.current=E,i===null&&(i=requestAnimationFrame(()=>{g(F.current),i=null})),N(!0),R(!0),D()},h=B.current;return h.addEventListener("wheel",p,{passive:!1}),()=>{h.removeEventListener("wheel",p),i!==null&&cancelAnimationFrame(i)}},[e,D]);const ue=i=>{i.target===i.currentTarget&&a()},Z=o.useRef(new Map),Q=o.useCallback((i,p)=>{i.stopPropagation();const h=Z.current.get(p);h&&clearTimeout(h);const j=setTimeout(()=>{S(p),r&&r(p),Z.current.delete(p)},100);Z.current.set(p,j)},[r]),X=o.useMemo(()=>{if(!B.current)return n;const i=200,p=T,h=-m.x/p-i,j=-m.x/p+(window.innerWidth||1920)/p+i,M=-m.y/p-i,E=-m.y/p+(window.innerHeight||1080)/p+i;return n.filter(_=>{const C=_.x,L=_.y;return C>=h&&C<=j&&L>=M&&L<=E})},[n,T,m]),se=o.useMemo(()=>X.filter(i=>i.parentId).map(i=>{const p=n.find(h=>h.id===i.parentId);return p?{from:p,to:i,type:"hard"}:null}).filter(Boolean),[X,n]),re=o.useMemo(()=>b.map(i=>{const p=n.find(_=>_.id===i.parentId),h=n.find(_=>_.id===i.childId);if(!p||!h)return null;const j=X.some(_=>_.id===p.id),M=X.some(_=>_.id===h.id);return!j||!M||p.id===h.parentId||h.id===p.parentId?null:{from:p,to:h,type:"soft"}}).filter(Boolean),[n,b,X]),Re=i=>i===0||i===1?"foreground":i===2||i===3?"midfield":"background",ne=o.useCallback((i,p,h)=>{if(i===0)return Math.max(.8,h*Math.min(1,p/.5));if(i===999){if(p<1.8)return 0;const _=Math.min(1,(p-1.8)/.4);return h*_}const j=.5+(i-1)*.3,M=j+.4;if(p<j)return 0;if(p>M)return h;const E=(p-j)/(M-j);return h*E},[]),fe=o.useCallback((i,p,h)=>{const j=Re(i),M=i===0,E=i>0&&i<=3,_=i>3,C=i===999;let L=1,A=0,P=1;j==="foreground"?(L=1,A=0,P=1):j==="midfield"?(L=.45,A=2.5,P=.65):(L=.1,A=4.5,P=0),C&&(L=.06,A=5,P=0);const W=ne(i,p,L),ae=ne(i,p,P);let z=64;if(M?z=120:C?z=28:_?z=48:i===1?z=64:z=56,E&&h){const $e=(h.split("").reduce((Ie,Pe)=>Ie+Pe.charCodeAt(0),0)%11-5)*.02;z=z*(1+$e)}const O=1+(p-1)*.2,J=z*O;let Y=1;return M?Y=3:Y=1,{opacity:W,size:J,borderWidth:Y,layer:j,isSpark:M,isContinuation:E,isCrossLink:_,isDistant:C,blur:A,labelOpacity:ae}},[ne]),he=(i,p,h)=>h?i>2:p===0?!0:p>=4?i>2:i>1.5?p<=3:i>.8?p<=2:p===1;return o.useMemo(()=>[...se,...re],[se,re]),e?s.jsx(ke,{children:s.jsxs(I.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-[var(--background)]/95 backdrop-blur-xl",onMouseMove:()=>{N(!0),R(!0),D()},children:[s.jsx(mt,{nodes:n,sparkPosition:n.find(i=>i.depth===0)?{x:0,y:0}:void 0}),s.jsx(ee,{variant:"ghost",size:"icon",onClick:a,className:"absolute top-20 right-4 z-[60] text-[var(--text-primary)] hover:text-white hover:bg-red-500/20 backdrop-blur-md bg-[var(--glass-bg)]/60 border-2 border-white/20 hover:border-red-400/50 rounded-lg shadow-[0_2px_8px_rgba(0,0,0,0.15)]",title:"Close map view (Esc)",children:s.jsx(Ue,{className:"w-5 h-5"})}),s.jsxs(I.div,{className:"absolute top-20 left-4 flex items-center z-[60] pointer-events-auto",style:{right:"80px"},initial:{opacity:1},animate:{opacity:$?1:.3},transition:{duration:.3},onHoverStart:()=>N(!0),onHoverEnd:()=>D(),children:[s.jsx("h2",{className:"text-lg font-medium text-[var(--text-primary)] backdrop-blur-md bg-[var(--glass-bg)]/50 px-4 py-2 rounded-lg border border-[var(--glass-border)]/50 shadow-[0_2px_8px_rgba(0,0,0,0.1)]",children:"Thread Constellation"}),s.jsxs("div",{className:"flex items-center gap-2 backdrop-blur-md bg-[var(--glass-bg)]/50 px-3 py-2 rounded-lg border border-[var(--glass-border)]/50 ml-2 shadow-[0_2px_8px_rgba(0,0,0,0.1)]",children:[s.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>{const i=Math.max(.5,F.current-.2);F.current=i,g(i),N(!0),D()},className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:s.jsx(Je,{className:"w-5 h-5"})}),s.jsxs("span",{className:"text-sm text-[var(--text-tertiary)] min-w-[3rem] text-center",children:[Math.round(T*100),"%"]}),s.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>{const i=Math.min(3,F.current+.2);F.current=i,g(i),N(!0),D()},className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:s.jsx(Qe,{className:"w-5 h-5"})})]})]}),s.jsx(I.div,{ref:B,className:"absolute inset-0 overflow-hidden cursor-grab active:cursor-grabbing",style:{paddingTop:"120px",paddingBottom:"80px",paddingLeft:"20px",paddingRight:"20px"},drag:!0,dragMomentum:!1,dragConstraints:{left:0,right:0,top:0,bottom:0},onDragStart:()=>{U.current=m},onDrag:(i,p)=>{U.current={x:m.x+p.delta.x,y:m.y+p.delta.y},x(U.current)},onClick:ue,children:s.jsxs(I.div,{style:{scale:T,x:m.x,y:m.y,willChange:"transform"},className:"absolute inset-0 flex items-center justify-center",children:[re.map((i,p)=>i&&s.jsx(be,{from:i.from,to:i.to,type:"soft"},`soft-${p}`)),se.map((i,p)=>i&&s.jsx(be,{from:i.from,to:i.to,type:"hard"},`hard-${p}`)),n.find(i=>i.depth===0)&&s.jsx("div",{className:"absolute pointer-events-none",style:{left:"50%",top:"50%",transform:"translate(-50%, -50%)",width:"500px",height:"500px",borderRadius:"50%",border:"1px solid rgba(72, 159, 227, 0.2)",boxShadow:"0 0 40px rgba(72, 159, 227, 0.15), inset 0 0 40px rgba(72, 159, 227, 0.05)",zIndex:1}}),T>1.5&&l.map((i,p)=>{const h=fe(i.depth,T,i.id),j=he(T,i.depth,!0);return h.opacity<=0?null:s.jsxs(I.div,{initial:{opacity:0},animate:{opacity:h.opacity},transition:{duration:.2},className:"absolute pointer-events-none",style:{left:`calc(50% + ${i.x}px)`,top:`calc(50% + ${i.y}px)`,transform:"translate(-50%, -50%)",zIndex:1,willChange:"opacity"},children:[s.jsx("div",{className:"rounded-full",style:{width:`${h.size}px`,height:`${h.size}px`,backgroundColor:"rgba(72, 159, 227, 0.1)",border:"1px solid rgba(72, 159, 227, 0.2)",filter:`blur(${h.blur}px)`}}),j&&s.jsx("p",{className:"absolute -bottom-4 left-1/2 -translate-x-1/2 text-[8px] text-[var(--text-secondary)] opacity-30 whitespace-nowrap",children:i.title?.slice(0,15)||i.content.slice(0,15)})]},`distant-${i.id}`)}),X.map(i=>{const p=n.find(C=>C.depth===0),h=fe(i.depth,T,i.id),j=he(T,i.depth,!1),M=h.isSpark?30:h.layer==="foreground"?20:h.layer==="midfield"?10:5;if(h.opacity<=0)return null;let E="translate(-50%, -50%)",_={x:0,y:0};if(h.isContinuation&&p&&i.depth>0){const C=p.x-i.x,L=p.y-i.y;E=`translate(-50%, -50%) rotate(${Math.atan2(L,C)*(180/Math.PI)+90+3}deg)`;const W=Math.sqrt(C*C+L*L);_={x:-C/W*3,y:-L/W*3}}return s.jsxs(I.div,{initial:{opacity:0,scale:0},animate:{opacity:h.opacity,scale:1},transition:{opacity:{duration:.2},scale:{type:"spring",stiffness:200,damping:20}},onClick:C=>{C.stopPropagation(),Q(C,i.id),N(!0),R(!0),D()},className:w("absolute cursor-pointer","hover:z-50"),style:{left:`calc(50% + ${i.x}px)`,top:`calc(50% + ${i.y}px)`,transform:E,zIndex:M,willChange:"opacity, transform"},children:[h.isSpark&&s.jsx(s.Fragment,{children:s.jsx("div",{className:"absolute inset-0 rounded-full pointer-events-none",style:{width:`${h.size+20}px`,height:`${h.size+20}px`,left:"50%",top:"50%",transform:"translate(-50%, -50%)",background:"radial-gradient(circle, hsl(var(--accent)) 0%, hsl(var(--accent)) 20%, transparent 70%)",opacity:.3,filter:"blur(8px)"}})}),s.jsxs("div",{className:w("flex items-center justify-center text-center p-3 relative","border backdrop-blur-sm","hover:scale-110",h.isSpark&&"rounded-full",h.isCrossLink&&"rounded-lg",!h.isCrossLink&&!h.isSpark&&"rounded-full"),style:{backdropFilter:h.isSpark?"var(--glass-blur)":"blur(calc(var(--glass-blur) * 0.7))",width:`${h.size}px`,height:`${h.size}px`,minWidth:`${h.size}px`,minHeight:`${h.size}px`,backgroundColor:h.isSpark?"var(--glass-bg)":h.isCrossLink?"rgba(72, 159, 227, 0.15)":"var(--glass-bg)",borderWidth:`${h.borderWidth}px`,borderStyle:h.isCrossLink?"dashed":"solid",borderColor:h.isSpark?"hsl(var(--accent)) / 0.8":h.isContinuation?"rgba(255, 255, 255, 0.3)":"rgba(255, 255, 255, 0.2)",backgroundImage:h.isContinuation?"radial-gradient(circle at 45% 45%, rgba(72, 159, 227, 0.2), rgba(72, 159, 227, 0.05))":void 0,boxShadow:h.isSpark?"0 0 40px hsl(var(--accent)) / 0.6, 0 0 20px hsl(var(--accent)) / 0.4":h.isContinuation?`${_.x}px ${_.y}px 12px rgba(72, 159, 227, 0.15), 0 0 8px rgba(72, 159, 227, 0.1)`:"0 0 8px rgba(72, 159, 227, 0.05)",filter:h.blur>0?`blur(${h.blur}px)`:void 0,opacity:1,transition:"transform 0.2s ease-out, box-shadow 0.2s ease-out",willChange:"transform"},children:[j&&s.jsx("p",{className:w("line-clamp-2 px-1",h.isSpark?"text-xs font-medium text-[var(--text-primary)]":h.isCrossLink?"text-[9px] text-[var(--text-secondary)]":"text-[10px] text-[var(--text-secondary)]"),style:{opacity:h.labelOpacity},children:i.title||i.content.slice(0,h.isSpark?50:30)}),!j&&h.isSpark&&s.jsx("div",{className:"w-4 h-4 rounded-full bg-[hsl(var(--accent))] opacity-80"})]}),i.depth>0&&u>1.2&&s.jsxs("div",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 text-[8px] text-[var(--text-tertiary)]",children:["L",i.depth]})]},i.id)})]})}),s.jsxs(I.div,{className:"absolute bottom-4 left-4 flex items-center gap-3 text-xs text-[var(--text-secondary)] backdrop-blur-md bg-[var(--glass-bg)]/50 px-4 py-2 rounded-lg border border-[var(--glass-border)]/50 shadow-[0_2px_8px_rgba(0,0,0,0.1)]",initial:{opacity:1},animate:{opacity:H?.7:.2},transition:{duration:.3},onHoverStart:()=>R(!0),onHoverEnd:()=>D(),children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-3 h-3 rounded-full bg-[hsl(var(--accent))] border-2 border-[hsl(var(--accent))]/80 shadow-[0_0_8px_hsl(var(--accent))/0.5]"}),s.jsx("span",{children:"Spark"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-2.5 h-2.5 rounded-full bg-[var(--glass-bg)] border border-[var(--glass-border)]"}),s.jsx("span",{children:"Continuation"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-2 h-2 rounded-lg bg-white/20 border border-dashed border-white/60"}),s.jsx("span",{children:"Cross-link"})]}),s.jsx("span",{className:"text-[var(--text-tertiary)]",children:"|"}),s.jsx("span",{className:"text-[10px]",children:"Drag to pan, scroll to zoom"})]}),f&&s.jsx(Ke,{isOpen:!!f,onClose:()=>{y(null),S(null)},post:f})]})}):null}const bt=({children:t,index:e,postId:a,postTitle:r,isBusiness:n})=>{const[d,l]=o.useState(!1),c=n?{background:"#EAE6E2",borderRadius:"24px",boxShadow:d?"10px 10px 24px rgba(166, 150, 130, 0.35), -10px -10px 24px rgba(255, 255, 255, 0.95)":"8px 8px 20px rgba(166, 150, 130, 0.3), -8px -8px 20px rgba(255, 255, 255, 0.85)",transition:"all 0.3s ease-out",transform:d?"translateY(-2px)":"translateY(0)"}:{};return s.jsxs("li",{className:w("w-full rounded-3xl overflow-visible relative group","animate-feed-card-enter"),style:{animationDelay:`${e*80}ms`,animationFillMode:"backwards"},onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),children:[!n&&s.jsx(ge,{postId:a,isHovered:d,position:"above"}),!n&&s.jsx("div",{className:"absolute -bottom-6 left-8 w-0.5 h-6 pointer-events-none z-10",style:{background:"hsl(var(--accent))",boxShadow:"0 0 8px hsl(var(--accent)), 0 0 4px hsl(var(--accent))80",opacity:.9}}),s.jsx(ht,{postId:a,postTitle:r,children:s.jsx("div",{className:w("rounded-3xl overflow-hidden","transition-all duration-500 ease-out",!n&&["backdrop-blur-xl","bg-white/5 dark:bg-white/10","border border-white/10","shadow-[0_0_20px_rgba(0,0,0,0.25)]","group-hover:bg-white/8 group-hover:shadow-[0_0_30px_rgba(72,159,227,0.2)]","group-hover:border-white/20"]),style:c,children:t})}),!n&&s.jsx(ge,{postId:a,isHovered:d,position:"below"})]})},ve=o.memo(function({items:e,onEndReached:a,loading:r,onSelect:n,authorMap:d}){const{lens:l}=Ce(),c=l==="business",b=Se(f=>f.setActivePost),v=o.useRef(null),u=o.useRef(null),[g,m]=o.useState(null);o.useEffect(()=>{if(u.current)return v.current=new IntersectionObserver(f=>{f[0].isIntersecting&&!r&&a()},{threshold:.4}),v.current.observe(u.current),()=>{v.current&&v.current.disconnect()}},[a,r]),o.useEffect(()=>{const f=y=>{m(y.detail.postId)};return window.addEventListener("pb:post:preview",f),()=>{window.removeEventListener("pb:post:preview",f)}},[]);const x=f=>{window.dispatchEvent(new CustomEvent("pb:brainstorm:show-thread",{detail:{post:f,postId:f.id}})),n?n(f):b(f)};return e.length===0&&!r?s.jsx("div",{className:"mx-auto w-full max-w-3xl px-4 py-12",children:s.jsxs("div",{className:w("rounded-3xl p-8 text-center",c?"bg-[#EAE6E2]":"bg-white/5 backdrop-blur-xl border border-white/10"),style:c?{boxShadow:"8px 8px 20px rgba(166, 150, 130, 0.3), -8px -8px 20px rgba(255, 255, 255, 0.85)"}:void 0,children:[s.jsx("div",{className:w("w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center",c?"bg-[#4A7C9B]/10":"bg-[var(--accent)]/10"),children:s.jsx("svg",{className:w("w-8 h-8",c?"text-[#4A7C9B]":"text-[var(--accent)]"),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})})}),s.jsx("h3",{className:w("text-lg font-semibold mb-2",c?"text-[#3D3833]":"text-white"),children:c?"No business insights yet":"No sparks yet"}),s.jsx("p",{className:w("text-sm mb-4",c?"text-[#6B635B]":"text-white/60"),children:c?"Business insights will appear here once members start sharing.":"Be the first to spark a conversation! Share your thoughts with the community."})]})}):s.jsxs(s.Fragment,{children:[s.jsxs("ul",{className:"mx-auto w-full max-w-3xl px-4 space-y-8 pb-20 relative",children:[!c&&s.jsx("div",{className:"absolute left-8 top-0 bottom-20 w-px bg-gradient-to-b from-transparent via-white/10 to-transparent pointer-events-none"}),e.map((f,y)=>s.jsx(bt,{index:y,postId:f.id,postTitle:f.title||f.content?.slice(0,40),isBusiness:c,children:s.jsx(de,{post:f,onSelect:x,authorDisplayName:d?.get(f.user_id??"")})},f.id))]}),r&&s.jsx("div",{className:"py-4 text-center",children:s.jsxs("div",{className:"inline-flex items-center gap-2",style:{color:c?"#6B635B":"var(--muted-foreground)"},children:[s.jsx("div",{className:"w-2 h-2 rounded-full animate-pulse",style:{background:c?"#4A7C9B":"var(--accent)"}}),s.jsx("span",{children:"Loading..."})]})}),s.jsx("div",{ref:u,style:{height:"1px"}}),s.jsx(Le,{rootPostId:g||"",isOpen:!!g,onClose:()=>m(null),onSelectPost:f=>{m(null);const y=e.find(k=>k.id===f);y&&x(y)}})]})});function ce({continuation:t,depth:e,isExpanded:a=!1,fadeOpacity:r=1,onSelect:n}){const d=b=>{n(b.id)},l=e===1?"scale-[0.97]":e===2?"scale-[0.95]":"scale-[0.93]",c=e===1?"pl-6":e===2?"pl-10":"pl-14";return s.jsxs("div",{className:w("relative transition-all duration-300",c),style:{opacity:r},children:[s.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-0.5 pointer-events-none",style:{background:"hsl(var(--accent))",boxShadow:r>.7?"0 0 8px hsl(var(--accent)), 0 0 4px hsl(var(--accent))80":"0 0 4px hsl(var(--accent))40",opacity:r*.9}}),s.jsx("div",{className:w("relative transform origin-left",l,"transition-all duration-300"),children:s.jsx("div",{className:w("rounded-2xl overflow-hidden","backdrop-blur-xl","bg-white/5 dark:bg-white/8","border border-white/10","shadow-[0_0_10px_rgba(0,0,0,0.15)]",e>=2?"text-sm":"text-base","hover:shadow-[0_0_15px_rgba(72,159,227,0.2)] transition-all"),children:s.jsx(de,{post:t.post,onSelect:d})})})]})}function vt({cluster:t,onSelectPost:e,onExpandDeeper:a}){const[r,n]=o.useState(!1);nt(t,5);const d=at(t,5),l=it(t),c=l>0,b=d.length>5,v=r?t.continuations.filter(f=>f.depth===2).slice(0,5):[],u=r?t.continuations.filter(f=>f.depth===3).slice(0,5):[],g=f=>{e(f.id)},m=()=>{(c||b)&&(a?a(t.spark.id):n(!r))},x=r?d:d.slice(0,5);return s.jsxs("div",{className:"relative w-full",children:[s.jsx("div",{className:"relative z-10",children:s.jsx("div",{className:w("rounded-3xl overflow-hidden","transition-all duration-300","ring-2 ring-white/5 hover:ring-white/10"),children:s.jsx(de,{post:t.spark,onSelect:g})})}),x.length>0&&s.jsxs("div",{className:"mt-5 space-y-4",children:[x.map((f,y)=>s.jsx(ce,{continuation:f,depth:1,fadeOpacity:f.fadeOpacity,onSelect:e},f.post.id)),r&&v.length>0&&s.jsx("div",{className:"space-y-3 animate-in slide-in-from-top-2 duration-300",children:v.map(f=>s.jsx(ce,{continuation:f,depth:2,isExpanded:!0,onSelect:e},f.post.id))}),r&&u.length>0&&s.jsx("div",{className:"space-y-3 animate-in slide-in-from-top-2 duration-300",children:u.map(f=>s.jsx(ce,{continuation:f,depth:3,isExpanded:!0,onSelect:e},f.post.id))}),(c||b)&&s.jsx("div",{className:w("pl-6 pt-3"),children:s.jsx(ee,{variant:"ghost",size:"sm",onClick:m,className:w("text-xs text-[var(--text-secondary)] hover:text-[var(--text-primary)]","hover:bg-white/5","border border-white/10 hover:border-white/20","rounded-xl px-4 py-2","transition-all duration-200"),children:r?s.jsxs(s.Fragment,{children:[s.jsx(je,{className:"w-3 h-3 mr-1.5"}),"Hide deeper continuations"]}):s.jsxs(s.Fragment,{children:[s.jsx(Ne,{className:"w-3 h-3 mr-1.5"}),"+ ",l+Math.max(0,d.length-5)," more continuation",l+Math.max(0,d.length-5)!==1?"s":""]})})})]})]})}const yt=o.memo(function({clusters:e,onEndReached:a,loading:r,onSelect:n}){const{lens:d}=Ce(),l=d==="business",c=o.useRef(null),b=o.useRef(null),[v,u]=o.useState(null);o.useEffect(()=>{if(b.current)return c.current=new IntersectionObserver(x=>{x[0].isIntersecting&&!r&&a()},{threshold:.4}),c.current.observe(b.current),()=>{c.current&&c.current.disconnect()}},[a,r]),o.useEffect(()=>{const x=f=>{u(f.detail.postId)};return window.addEventListener("pb:post:preview",x),()=>{window.removeEventListener("pb:post:preview",x)}},[]);const g=x=>{for(const f of e){if(f.spark.id===x){n(f.spark);return}const y=f.continuations.find(k=>k.post.id===x);if(y){n(y.post);return}}},m=x=>{u(x)};return e.length===0&&!r?s.jsx("div",{className:"mx-auto w-full max-w-3xl px-4 py-12",children:s.jsxs("div",{className:w("rounded-3xl p-8 text-center",l?"bg-[#EAE6E2]":"bg-white/5 backdrop-blur-xl border border-white/10"),style:l?{boxShadow:"8px 8px 20px rgba(166, 150, 130, 0.3), -8px -8px 20px rgba(255, 255, 255, 0.85)"}:void 0,children:[s.jsx("div",{className:w("w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center",l?"bg-[#4A7C9B]/10":"bg-[var(--accent)]/10"),children:s.jsx("svg",{className:w("w-8 h-8",l?"text-[#4A7C9B]":"text-[var(--accent)]"),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})})}),s.jsx("h3",{className:w("text-lg font-semibold mb-2",l?"text-[#3D3833]":"text-white"),children:l?"No business insights yet":"No idea clusters yet"}),s.jsx("p",{className:w("text-sm mb-4",l?"text-[#6B635B]":"text-white/60"),children:l?"Business insights will appear here once members start sharing.":"Be the first to spark a conversation! Share your thoughts with the community."})]})}):s.jsxs(s.Fragment,{children:[s.jsx("ul",{className:"mx-auto w-full max-w-3xl px-4 space-y-10 pb-20 relative",children:e.map((x,f)=>s.jsx("li",{className:w("w-full relative","animate-feed-card-enter"),style:{animationDelay:`${f*80}ms`,animationFillMode:"backwards"},children:s.jsx(vt,{cluster:x,onSelectPost:g,onExpandDeeper:m})},x.spark.id))}),r&&s.jsx("div",{className:"py-4 text-center",children:s.jsxs("div",{className:"inline-flex items-center gap-2",style:{color:l?"#6B635B":"var(--muted-foreground)"},children:[s.jsx("div",{className:"w-2 h-2 rounded-full animate-pulse",style:{background:l?"#4A7C9B":"var(--accent)"}}),s.jsx("span",{children:"Loading..."})]})}),s.jsx("div",{ref:b,style:{height:"1px"}}),s.jsx(Le,{rootPostId:v||"",isOpen:!!v,onClose:()=>u(null),onSelectPost:x=>{u(null),g(x)}})]})}),wt=["Spark"],_t=["BusinessInsight"];function Lt({mode:t,activePostId:e=null,initialKinds:a,onItemsChange:r,renderFeed:n}){const[d,l]=o.useState(null),c=Se(k=>k.lastSeen),{data:b}=Ze(),v=o.useMemo(()=>a||(t==="business"?_t:wt),[a,t]),u=t==="public"||t==="business"||t==="brainstorm_main",g=ft({kinds:v}),m=o.useMemo(()=>t!=="business"?null:b?.[0]?.org_id??null,[t,b]);o.useEffect(()=>{t==="brainstorm_last_seen"&&r?.(c)},[t,c,r]);const x=t==="public",f=dt({mode:t,kinds:u?g.kinds:v,sort:u?g.sort:void 0,search:u?g.search:void 0,org_id:m,activePostId:e,pageSize:20}),y=ut({mode:t==="public"?"public":"business",kinds:u?g.kinds:v,search:u?g.search:void 0,org_id:m,pageSize:20});if(o.useEffect(()=>{if(t!=="brainstorm_last_seen")if(x){const k=y.clusters.flatMap(S=>[S.spark,...S.continuations.map($=>$.post)]);r?.(k)}else r?.(f.items)},[t,f.items,y.clusters,r,x]),t==="brainstorm_last_seen"){const k={items:c,loadMore:async()=>{},loading:!1,eof:!0,refresh:async()=>{}};return n?s.jsx(s.Fragment,{children:n(c,{...k,authorMap:new Map})}):s.jsx("div",{style:{flex:1},children:s.jsx(ve,{items:k.items,onEndReached:k.loadMore,loading:k.loading,onSelect:l})})}if(x){const k=S=>{l(S),r?.([S]),window.dispatchEvent(new CustomEvent("pb:brainstorm:show-thread",{detail:{post:S,postId:S.id}}))};return s.jsx("div",{style:{flex:1},children:s.jsx(yt,{clusters:y.clusters,onEndReached:y.loadMore,loading:y.loading,onSelect:k})})}return n?s.jsx(s.Fragment,{children:n(f.items,f)}):s.jsx("div",{style:{flex:1},children:s.jsx(ve,{items:f.items,onEndReached:f.loadMore,loading:f.loading,onSelect:l,authorMap:f.authorMap})})}function kt({onRefresh:t,threshold:e=80,enabled:a=!0}){const[r,n]=o.useState(!1),[d,l]=o.useState(0),c=_e(),{triggerHaptic:b}=Xe(),v=o.useCallback(()=>!a||!c||r?!1:window.scrollY===0,[a,c,r]),u=o.useCallback(m=>{if(!a||!c||r)return;const x=Math.min(1,m/(e*2)),f=m*x;l(Math.max(0,f)),f>=e&&d<e&&b("medium")},[a,c,r,e,d,b]),g=o.useCallback(async m=>{if(!a||!c||r){l(0);return}const x=Math.min(1,m/(e*2));if(m*x>=e){n(!0),b("success");try{await t()}finally{setTimeout(()=>{n(!1),l(0)},500)}}else l(0)},[a,c,r,e,t,b]);return{isRefreshing:r,pullDistance:d,isPulling:d>0,handleDragStart:v,handleDrag:u,handleDragEnd:g,isMobile:c}}function Rt({children:t,onRefresh:e,enabled:a=!0}){const{isRefreshing:r,pullDistance:n,isPulling:d,handleDragStart:l,handleDrag:c,handleDragEnd:b,isMobile:v}=kt({onRefresh:e,enabled:a});if(!v)return s.jsx(s.Fragment,{children:t});const g=Math.min(n/80,1)*360;return s.jsxs("div",{className:"relative",children:[s.jsx(I.div,{className:"absolute top-0 left-1/2 -translate-x-1/2 z-50 pointer-events-none",animate:{y:r?40:Math.min(n-20,40),opacity:d||r?1:0},transition:{type:"spring",stiffness:300,damping:30},children:s.jsx("div",{className:w("w-10 h-10 rounded-full flex items-center justify-center","backdrop-blur-xl border shadow-lg","bg-background/90 border-border/20"),children:s.jsx(Ge,{className:w("w-5 h-5 text-primary transition-transform",r&&"animate-spin"),style:{transform:r?void 0:`rotate(${g}deg)`}})})}),s.jsx(I.div,{drag:"y",dragConstraints:{top:0,bottom:0},dragElastic:0,onDragStart:(m,x)=>{if(!l())return!1},onDrag:(m,x)=>{x.offset.y>0&&c(x.offset.y)},onDragEnd:(m,x)=>{b(x.offset.y)},animate:{y:r?20:0},transition:{type:"spring",stiffness:300,damping:30},children:t})]})}export{Lt as F,Rt as P};
