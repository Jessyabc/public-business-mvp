const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rpc-CPiWz0sY.js","assets/index-DdiXzYE2.js","assets/index-s0UwzZhW.css"])))=>i.map(i=>d[i]);
import{u as S,ap as R,r as y,s as c,b4 as C,_ as j,b5 as F,b6 as T,b7 as L}from"./index-DdiXzYE2.js";function b(i){return i.type==="brainstorm"&&i.kind==="Spark"}function k(i){return i.type==="insight"&&i.kind==="BusinessInsight"}function N(i,n,m){const o=b(i),d=k(i),a=b(n),u=k(n);return!o&&!d||!a&&!u?!1:m==="origin"?!!(o&&a||d&&u):!!(o&&a||o&&u||d&&a||d&&u)}function Y(){const{user:i}=S(),{toast:n}=R(),[m,o]=y.useState(!1),[d,a]=y.useState([]),[u,f]=y.useState(null),g=y.useCallback(async t=>{o(!0),f(null);try{let e=c.from("posts").select("*").eq("status","active").order("created_at",{ascending:!1});t&&(e=e.eq("mode",t));const{data:r,error:s}=await e;if(s)throw s;a(r||[])}catch(e){console.error("Error fetching posts:",e);const r=e instanceof Error||e&&typeof e=="object"&&"message"in e&&typeof e.message=="string"?e.message:"Failed to fetch posts";f(r),n({title:"Error",description:r,variant:"destructive"})}finally{o(!1)}},[n]),_=async t=>{if(!i)return n({title:"Authentication Required",description:"Please sign in to create a post",variant:"destructive"}),null;if(t.mode==="business"&&t.type!=="brainstorm"){const{rpcCanCreateBusinessPosts:e}=await j(async()=>{const{rpcCanCreateBusinessPosts:s}=await import("./rpc-CPiWz0sY.js");return{rpcCanCreateBusinessPosts:s}},__vite__mapDeps([0,1,2])),{data:r}=await e(i.id);if(!r)return n({title:"Business Member Required",description:"You need to be a Business member to create business posts. Business membership is available by invitation only.",variant:"destructive"}),null}o(!0);try{console.log("Creating post with data:",{user_id:i.id,...t});let e;if(t.type==="brainstorm")e=F({userId:i.id,content:t.content,title:t.title,metadata:t.metadata});else if(t.type==="insight"&&t.mode==="business"){if(!t.org_id)return n({title:"Organization Required",description:"Business insights require an organization ID",variant:"destructive"}),o(!1),null;if(!t.title)return n({title:"Title Required",description:"Business insights require a title",variant:"destructive"}),o(!1),null;e=T({userId:i.id,orgId:t.org_id,content:t.content,title:t.title,metadata:t.metadata})}else e={user_id:i.id,content:t.content,type:t.type,mode:t.mode,title:t.title??null,body:t.body??t.content,kind:t.kind,visibility:t.visibility,status:t.status??"active",org_id:t.org_id,metadata:t.metadata?JSON.parse(JSON.stringify(t.metadata)):{}};L(e);const{data:r,error:s}=await c.from("posts").insert(e).select().single();if(console.log("Post creation result:",{data:r,error:s}),s)throw console.error("Post creation error details:",s),s;return a(l=>[r,...l]),n({title:"Success",description:`${t.type==="brainstorm"?"Brainstorm":"Post"} created successfully`}),r}catch(e){console.error("Error creating post:",e);let r="Failed to create post";throw(e instanceof Error||e&&typeof e=="object"&&"message"in e&&typeof e.message=="string")&&(r=e.message),n({title:"Error",description:r,variant:"destructive"}),e}finally{o(!1)}},w=async(t,e)=>{const r=await _(t);if(!r||!e)return r;try{const{data:s,error:l}=await c.from("posts").select("id, type, kind").eq("id",e.parent_post_id).single();if(l)return console.error("Error fetching parent post:",l),n({title:"Relation not linked",description:"Your post was created but linking failed.",variant:"destructive"}),r;if(!s)return console.error("Parent post not found"),n({title:"Relation not linked",description:"Your post was created but linking failed.",variant:"destructive"}),r;const h={id:s.id,type:s.type,kind:s.kind||void 0},p={id:r.id,type:r.type,kind:r.kind||void 0};if(!N(h,p,e.relation_type))return console.warn("Lineage rule violation: Cannot link",{parent:{type:s.type,kind:s.kind},child:{type:r.type,kind:r.kind},relationType:e.relation_type}),n({title:"Relation not linked",description:"This type of post cannot be linked to that type of post yet.",variant:"destructive"}),r;const{error:v}=await c.from("post_relations").insert({parent_post_id:e.parent_post_id,child_post_id:r.id,relation_type:e.relation_type});if(v)throw v}catch(s){console.error("Error creating post relation:",s),n({title:"Relation not linked",description:"Your post was created but linking failed.",variant:"destructive"})}return r},P=async(t,e)=>{if(!i)return null;o(!0);try{const r=C({content:e.content,title:e.title}),{data:s,error:l}=await c.from("posts").update(r).eq("id",t).eq("user_id",i.id).select().single();if(l)throw l;return a(h=>h.map(p=>p.id===t?{...p,...s}:p)),n({title:"Success",description:"Post updated successfully"}),s}catch(r){console.error("Error updating post:",r);let s="Failed to update post";throw(r instanceof Error||r&&typeof r=="object"&&"message"in r&&typeof r.message=="string")&&(s=r.message),n({title:"Error",description:s,variant:"destructive"}),r}finally{o(!1)}},E=async t=>{if(!i)return!1;o(!0);try{const{error:e}=await c.from("posts").delete().eq("id",t).eq("user_id",i.id);if(e)throw e;return a(r=>r.filter(s=>s.id!==t)),n({title:"Success",description:"Post deleted successfully"}),!0}catch(e){console.error("Error deleting post:",e);let r="Failed to delete post";return(e instanceof Error||e&&typeof e=="object"&&"message"in e&&typeof e.message=="string")&&(r=e.message),n({title:"Error",description:r,variant:"destructive"}),!1}finally{o(!1)}},q=async t=>{o(!0),f(null);try{const{data:e,error:r}=await c.from("posts").select("*").eq("id",t).eq("status","active").single();if(r)throw r;return e}catch(e){console.error("Error fetching post:",e);const r=e instanceof Error||e&&typeof e=="object"&&"message"in e&&typeof e.message=="string"?e.message:"Failed to fetch post";throw f(r),e}finally{o(!1)}},I=async t=>{try{const{data:e,error:r}=await c.from("post_relations").select(`
          *,
          child_post:posts!post_relations_child_post_id_fkey(*)
        `).eq("parent_post_id",t).in("relation_type",["origin","reply","quote","cross_link"]);if(r)throw r;return e||[]}catch(e){return console.error("Error fetching post relations:",e),[]}},B=async()=>{if(i){o(!0),f(null);try{const{data:t,error:e}=await c.from("my_posts_view").select("*").order("created_at",{ascending:!1});if(e)throw e;a(t||[])}catch(t){console.error("Error fetching user posts:",t);const e=t instanceof Error||t&&typeof t=="object"&&"message"in t&&typeof t.message=="string"?t.message:"Failed to fetch your posts";f(e),n({title:"Error",description:e,variant:"destructive"})}finally{o(!1)}}};return y.useEffect(()=>{i&&g()},[i,g]),{posts:d,loading:m,error:u,fetchPosts:g,fetchUserPosts:B,fetchPostById:q,fetchPostRelations:I,createPost:_,createPostWithRelation:w,updatePost:P,deletePost:E,refetch:g}}export{Y as u};
